<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8" />
	<title>認証コード入力</title>
	<!-- CSRFトークンとヘッダ名をメタタグで埋め込む -->
	<meta name="_csrf" th:content="${_csrf.token}" />
	<meta name="_csrf_header" th:content="${_csrf.headerName}" />
</head>

<body>
	<h1>認証コード入力</h1>
	<div id="errorMessage"></div>

	<form th:object="${form}">
		<label for="verificationCode">認証コード（6桁）:</label>
		<input type="number" id="verificationCode" th:field="*{code}" maxlength="6" />
		<div id="codeError"></div>
		<button type="button" id="submitBtn">送信</button>
	</form>

	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script th:inline="javascript">
		$(function () {

			var csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
			var csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
			$("#submitBtn").on("click", function () {
				var code = $("#verificationCode").val();
				$.ajax({
					url: "/user/verify-code",
					type: "POST",
					headers: {
						[csrfHeader]: csrfToken
					},
					data: {
						code: code
					},
					success: function () {
						window.location.href = "/user/registrationComplete";
					},
					error: function (xhr) {
						// クリア処理
						$("errorMessage, #codeError").text("");

						var errorResponse = xhr.responseJSON;

						// バリデーションエラー	
						if (xhr.status == 400) {
							var codeErrors = errorResponse.targetMessages.code;
							$("#codeError").html(codeErrors.join("<br>"));

							// 業務例外				
						} else if (xhr.status == 422) {
							var messages = errorResponse.messages || [];
							$("#errorMessage").html(messages.join("<br>"));

						}
					},
				});
			});
		});
	</script>
</body>

</html>